name: CI

on:
  merge_group:
  pull_request:
  push: # WARNING: Renovate sometimes automerges without PR, so we MUST build and test renovate/** branches
  workflow_call:
  workflow_dispatch:

concurrency:
  group: "${{ github.workflow }} @ ${{ github.event.compare || github.head_ref || github.ref }}"
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      any-workspace: ${{ steps.filter.outputs.any-workspace }}
      packages: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'
      - name: Debug info
        # https://docs.github.com/en/actions/reference/security/secure-use#use-an-intermediate-environment-variable
        env:
          GH_HEAD_REF: ${{ github.head_ref }}
        run: |
          cat <<EOF
          Scratch environment: ${{ vars.SCRATCH_ENV || '<none>' }}
          Node version: $(node --version)
          NPM version: $(npm --version)
          GitHub ref: ${{ github.ref }}
          GitHub head ref: ${GH_HEAD_REF}
          Working directory: $(pwd)
          EOF

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: ./.github/path-filters.yml

      - if: ${{ steps.filter.outputs.any-workspace == 'true' }}
        uses: ./.github/actions/install-dependencies

      - name: Build packages
        if: ${{ steps.filter.outputs.any-workspace == 'true' }}
        run: npm run build

      - name: Store build artifacts
        if: ${{ steps.filter.outputs.any-workspace == 'true' }}
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4
        with:
          name: build
          path: |
            packages/**/build
            packages/**/dist
            packages/**/playground

  test:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.outputs.any-workspace == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJSON(needs.build.outputs.packages) }}
        exclude:
          - package: global
          - package: any-workspace
    name: Test ${{ matrix.package }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'
      - uses: ./.github/actions/install-dependencies
      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: build
          path: packages
      - uses: ./.github/actions/test-package
        with:
          package_name: ${{ matrix.package }}

  preview:
    runs-on: ubuntu-latest
    needs:
      - build
      - test
    if: ${{ needs.build.outputs.any-workspace == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJSON(needs.build.outputs.packages) }}
        exclude:
          - package: global
          - package: any-workspace
    name: Test ${{ matrix.package }}
    steps:
      - name: Determine GitHub Pages directory name
        id: branch_dir_name
        run: |
          if [ "$GITHUB_REF_NAME" == "develop" ]; then
            echo "result=."
          else
            echo "result=${GITHUB_REF_NAME//[^A-Za-z0-9._-]/_}"
          fi | tee --append "$GITHUB_OUTPUT"
      - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: build
          path: packages
      - name: Deploy ${{ matrix.package }} testing playground to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packages/${{ matrix.package }}/playground
          destination_dir: "${{steps.branch_dir_name.outputs.result}}/${{ matrix.package }}"
          full_commit_message: "Build for ${{ github.sha }} ${{ github.event.head_commit.message }}"

  results:
    name: Results
    runs-on: ubuntu-latest
    needs:
      - test
      - preview
    if: ${{ always() }}
    steps:
      - run: |
          case "${{ needs.test.result }}" in
            success)
              echo "Tests passed successfully."
              exit 0
              ;;
            skipped)
              echo "Tests were unnecessary for these changes, so they were skipped."
              echo "If this is unexpected, check the path filters."
              exit 0
              ;;
            *)
              echo "Tests failed."
              exit 1
              ;;
          esac
      - run: |
          case "${{ needs.preview.result }}" in
            success)
              echo "GitHub Pages previews published successfully."
              exit 0
              ;;
            skipped)
              echo "Previews were unnecessary for these changes, so they were skipped."
              echo "If this is unexpected, check the path filters."
              exit 0
              ;;
            *)
              echo "Publishing GitHub Pages previews failed."
              exit 1
              ;;
          esac
