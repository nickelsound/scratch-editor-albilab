# Universal Dockerfile - jeden image pro frontend i backend
FROM node:22-alpine

# Nastav√≠me systemov√© limity
RUN echo "* soft nofile 65536" >> /etc/security/limits.conf 2>/dev/null || true && \
    echo "* hard nofile 65536" >> /etc/security/limits.conf 2>/dev/null || true

WORKDIR /app

# Zkop√≠rujeme v≈°echny package.json soubory
COPY package*.json ./
COPY packages/scratch-gui/package*.json ./packages/scratch-gui/
COPY packages/scratch-backend/package*.json ./packages/scratch-backend/
COPY packages/scratch-vm/package*.json ./packages/scratch-vm/
COPY packages/scratch-render/package*.json ./packages/scratch-render/
COPY packages/scratch-svg-renderer/package*.json ./packages/scratch-svg-renderer/

# Zkop√≠rujeme scripts pro prepare
COPY packages/scratch-gui/scripts ./packages/scratch-gui/scripts/

# Nainstalujeme v≈°echny z√°vislosti (pot≈ôebn√© pro obƒõ aplikace)
RUN npm config set fetch-timeout 300000 && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm install --ignore-scripts --no-audit --no-fund

# Zkop√≠rujeme zdrojov√© soubory (docs, test, playground jsou ignorov√°ny p≈ôes .dockerignore)
COPY packages/ ./packages/
COPY scripts/ ./scripts/

# Spust√≠me prepare script
RUN npm run prepare --workspace=packages/scratch-gui

# Build-time konfigurace pro produkƒçn√≠ URL backendu
# Tyto promƒõnn√© se pou≈æij√≠ v api-config.js (REACT_APP_API_PORT/WS_PORT)
ENV REACT_APP_API_PORT=3001
ENV REACT_APP_WS_PORT=3001

# Sestav√≠me v≈°echny bal√≠ƒçky (pot≈ôebn√© pro obƒõ aplikace)
# Pou≈æijeme NODE_ENV=production pro optimalizaci (bez source maps)
RUN NODE_ENV=production npm run build --workspace=packages/scratch-svg-renderer && \
    NODE_ENV=production npm run build --workspace=packages/scratch-render && \
    NODE_ENV=production npm run build --workspace=packages/scratch-vm && \
    NODE_ENV=production npm run build --workspace=packages/scratch-gui

# Odstran√≠me source maps z buildu (u≈°et≈ô√≠ ~200-300MB)
RUN find packages/*/build packages/*/dist -name "*.map" -type f -delete 2>/dev/null || true

# Odstran√≠me src adres√°≈ôe z built packages (u≈æ nejsou pot≈ôeba po buildu)
# POZOR: NESMAZAT packages/scratch-backend/src - backend ho pot≈ôebuje pro bƒõh!
RUN rm -rf packages/scratch-gui/src \
           packages/scratch-vm/src \
           packages/scratch-render/src \
           packages/scratch-svg-renderer/src \
           2>/dev/null || true

# Nainstalujeme serve pro frontend (pouze produkƒçn√≠ z√°vislosti)
RUN npm install -g serve --production

# Odstran√≠me dev dependencies a node_modules (u≈°et≈ô√≠ ~500-800MB)
# Ponech√°me pouze node_modules pro scratch-backend (pot≈ôebuje runtime z√°vislosti)
RUN npm prune --production && \
    rm -rf packages/scratch-gui/node_modules packages/scratch-vm/node_modules \
           packages/scratch-render/node_modules packages/scratch-svg-renderer/node_modules \
           packages/*/node_modules/.cache 2>/dev/null || true

# Vytvo≈ô√≠me entrypoint script pomoc√≠ echo (aby se vyhnulo probl√©m≈Øm s heredoc)
RUN echo '#!/bin/sh' > /app/entrypoint.sh && \
    echo 'case "${APP_MODE:-backend}" in' >> /app/entrypoint.sh && \
    echo '  frontend|gui)' >> /app/entrypoint.sh && \
    echo '    echo "üöÄ Spou≈°t√≠m Frontend server na portu ${PORT:-8601}..."' >> /app/entrypoint.sh && \
    echo '    exec serve -s packages/scratch-gui/build -l ${PORT:-8601}' >> /app/entrypoint.sh && \
    echo '    ;;' >> /app/entrypoint.sh && \
    echo '  backend|api)' >> /app/entrypoint.sh && \
    echo '    echo "üöÄ Spou≈°t√≠m Backend server na portu ${PORT:-3001}..."' >> /app/entrypoint.sh && \
    echo '    exec npm start --workspace=packages/scratch-backend' >> /app/entrypoint.sh && \
    echo '    ;;' >> /app/entrypoint.sh && \
    echo '  *)' >> /app/entrypoint.sh && \
    echo '    echo "‚ùå Neplatn√Ω APP_MODE: ${APP_MODE}"' >> /app/entrypoint.sh && \
    echo '    echo "   Pou≈æijte: frontend, gui, backend, nebo api"' >> /app/entrypoint.sh && \
    echo '    exit 1' >> /app/entrypoint.sh && \
    echo '    ;;' >> /app/entrypoint.sh && \
    echo 'esac' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

# Vytvo≈ô√≠me uploads adres√°≈ô
RUN mkdir -p uploads

# Exponujeme porty (frontend i backend)
EXPOSE 8601 3001 3002

# Nastav√≠me defaultn√≠ environment promƒõnn√©
ENV NODE_ENV=production
ENV APP_MODE=backend
ENV PORT=3001

# Pou≈æijeme entrypoint script
ENTRYPOINT ["/app/entrypoint.sh"]

